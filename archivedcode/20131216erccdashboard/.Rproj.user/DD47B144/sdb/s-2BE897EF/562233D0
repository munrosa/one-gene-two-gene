{
    "contents" : "#' Prepare differential expression testing results for spike-in analysis\n#'\n#' @param expDat    list, contains input data and stores analysis results\n#' \n#' @export\n#' @examples\n#' # After running initDat and est_r_m functions provide the resulting expDat \n#' # list as input to the geneExprTest function\n#' \n#' expDat <- geneExprTest(expDat)\n#' \ngeneExprTest <- function(expDat){\n  \n  cnt <- expDat$Transcripts\n  designMat <- expDat$designMat\n  sampleInfo <- expDat$sampleInfo\n  info <- designMat\n  choseFDR <- sampleInfo$choseFDR\n  \n  # set initial p.thresh\n  p.thresh<-.1\n  # First 3 columns of qvalFile must contain Feature, pvals, and qvals\n  \n  qvalFile <- paste(sampleInfo$filenameRoot,\"quasiSeq.res.csv\",sep=\".\")\n  pvalERCC <- paste(sampleInfo$filenameRoot, \"ERCC Pvals.csv\",sep=\" \")\n  #dispPlotFile = paste(sampleInfo$filenameRoot, \".DispPlot.RData\",sep = \"\")\n  \n    # Decide to reuse results or run testDE\n  if (file.exists(qvalFile) == TRUE){\n    deRes <- read.csv(qvalFile)\n    if (names(deRes)[3] != \"qvals\"){\n      stop(\"qvals column is missing in qvalFile\")\n    }\n    if (file.exists(pvalERCC) == TRUE){\n    cat(paste(\"\\n Differential expression test results exist, will use   \\n\",\n              \"existing P-values and Q-values for analysis.\\n\",\n              \"Delete\", qvalFile, \"if you want to repeat differential \\n\",\n              \"differential expression testing or view dispersion plots.    \\n\"))\n      if(any(deRes$qvals<choseFDR)){\n        p.thresh<-max(deRes$pvals[deRes$qvals<choseFDR])\n      }\n    }else{\n      cat(\"No P-values exist for ERCCs, starting differential expression tests\")\n      expDat <- suppressWarnings(testDE(sampleInfo, expDat, cnt = cnt, \n                                        info = info ))  \n      deRes <- read.csv(qvalFile)\n      if(any(deRes$qvals<choseFDR)){\n        p.thresh<-max(deRes$pvals[deRes$qvals<choseFDR])\n      }\n    }\n    \n  }\n  if(file.exists(qvalFile) == FALSE){\n    pvalERCC = paste(sampleInfo$filenameRoot, \"ERCC Pvals.csv\",sep=\" \")\n    if(file.exists(pvalERCC)){\n      cat(paste(\"\\n P-values exist for ERCCs, but Q-values are missing\\n\"))\n      # First three columns must be Feature, MnCnt, Pval\n      # Need to get Threshold p-value from user\n      getPThresh<- function(){\n        cat(\"\\nTo continue with P-values for LODR estimation\\n\")\n        readline(\"Enter the threshold P-value: \")\n      }\n      p.thresh <- as.numeric(getPThresh())\n      \n    }else{\n      cat(\"No P-values exist for ERCCs, starting differential expression tests\")\n      expDat <- suppressWarnings(testDE(sampleInfo, expDat, cnt = cnt, \n                                        info = info ))  \n      deRes <- read.csv(qvalFile)\n      if(any(deRes$qvals<choseFDR)){\n        p.thresh<-max(deRes$pvals[deRes$qvals<choseFDR])\n      } \n    }\n    \n  }\n\n\n  if(is.null(expDat$Figures$dispPlot)){\n      cat(paste(\"\\nDE testing results supplied without companion dispersion\\n\",\n              \"plot. Dispersion plot is unavailable to print.\\n\"))\n  }  \n  cat(\"\\nThreshold P-value\\n\")\n  cat(p.thresh,\"\\n\")\n  \n  if (p.thresh > .1){\n    cat(paste(\"Threshold P-value is high for the chosen FDR of \", \n                as.character(choseFDR)))\n    cat(paste(\"The sample comparison indicates a large amount of \\n\",\n              \"differential expression in the measured transcript \\n\",\n              \"populations\\n\"))\n  }\n  \n  \n  expDat$p.thresh <- p.thresh\n  return(expDat)\n  \n}\n",
    "created" : 1387228870772.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "25798902",
    "id" : "562233D0",
    "lastKnownWriteTime" : 1387162668,
    "path" : "~/Documents/NISTMunro/Projects/erccdashboard/R/geneExprTest.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}